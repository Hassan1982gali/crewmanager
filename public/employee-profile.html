<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ø­Ø±ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      padding: 20px;
      background-color: #f0f4f8;
      direction: rtl;
    }
    h2 {
      text-align: center;
      color: #1a237e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      text-align: center;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #90caf9;
      color: #0d47a1;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-inline {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .form-inline input {
      padding: 5px;
      flex: 1;
    }
    .form-inline button {
      padding: 6px 20px;
      background-color: #1a237e;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    .actions button {
      margin: 2px;
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .actions .edit {
      background-color: #ffb300;
      color: white;
    }
    .actions .delete {
      background-color: #d32f2f;
      color: white;
    }
    @media print {
  .print-buttons,
  .no-print {
    display: none !important;
  }
}

@media print {
  #toggle-complete-btn {
    display: none !important;
  }
}

.complete-toggle-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 25px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  transition: background 0.3s ease;
}

.complete-toggle-btn.complete {
  background-color: #28a745; /* Ø£Ø®Ø¶Ø± */
}

.complete-toggle-btn.incomplete {
  background-color: #dc3545; /* Ø£Ø­Ù…Ø± */
}
  </style>
</head>
<body>
  <h2>ğŸ“‹ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ø­Ø±ÙŠ</h2>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="export-certificates.html" target="_blank">
      <button style="padding: 10px 30px; background-color: #0d47a1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
        ğŸ“¥ ØªØµØ¯ÙŠØ± Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ù…
      </button>
    </a>
  </div>  

  <div class="print-buttons" style="text-align: center; margin-bottom: 20px;">
    <button onclick="window.print()" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„
    </button>
    <button onclick="printSection('certificates-section')" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©
    </button>
    <button onclick="printSection('service-section')" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©
    </button>
  </div>  

  <div class="no-print" style="text-align: center; margin-bottom: 15px;">
    <label style="font-weight: bold;">
      <input type="checkbox" id="toggle-evaluation-print" checked>
      ğŸ“‹ ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    </label>
  </div>  

  <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
    <div>
      <img id="profile-image" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid #ccc;">
    </div>
    <div class="no-print">
      <input type="file" id="upload-image" accept="image/*">
      <button onclick="uploadEmployeeImage()">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</button>
      <button id="delete-image-btn" onclick="deleteEmployeeImage()" style="background-color: #d32f2f; color: white; margin-right: 10px;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
      <p style="font-size: 14px; color: #555; margin-top: 5px;">
        ğŸ“¸ ÙŠÙØ¶Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¨Ø­Ø¬Ù… Ø£Ù‚Ù„ Ù…Ù† 500x500 Ø¨ÙƒØ³Ù„ØŒ ÙˆØ£Ù‚Ù„ Ù…Ù† 300 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª.
      </p>
    </div>    
  </div>  

  <div class="section">
    <p><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> <span id="profile-name">---</span></p>
    <p><strong>ğŸ–ï¸ Ø§Ù„Ø±ØªØ¨Ø©:</strong> <span id="profile-rank">---</span></p>
    <p><strong>âš“ Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="profile-status">---</span></p>
    <p><strong>â›´ï¸ Ø§Ù„Ù†Ø§Ù‚Ù„Ø©:</strong> <span id="profile-ship">---</span></p>
  
    <p><strong>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ 1:</strong>
      <input id="profile-phone1" type="text" placeholder="0780xxxxxxx"
        style="padding: 6px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Cairo', sans-serif; font-size: 16px;">
    </p>
  
    <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ 2:</strong>
      <input id="profile-phone2" type="text" placeholder="0770xxxxxxx"
        style="padding: 6px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Cairo', sans-serif; font-size: 16px;">
    </p>
  
    <p><strong>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong>
      <input id="profile-address" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø¨ØµØ±Ø© - Ø§Ù„Ù…Ø¹Ù‚Ù„"
        style="padding: 6px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Cairo', sans-serif; font-size: 16px; width: 100%;">
    </p>
  
    <div style="margin-top: 10px;">
      <button onclick="updateEmployeeInfo()"
        style="padding: 8px 20px; background-color: #0d47a1; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 16px;">
        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      </button>
    </div>
  </div>  

  <div class="section" id="certificates-section">
    <h3>ğŸ“ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h3> 
    <!-- âœ… Ø²Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù -->
<button id="toggle-complete-btn" class="complete-toggle-btn">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
  <span id="completion-status-msg" style="margin-right: 10px;"></span>
</div> 

    <div class="form-inline no-print">
      <input type="text" id="cert-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
      <input type="date" id="cert-issue" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±">
      <input type="date" id="cert-expiry" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙØ§Ø°">
      <button onclick="addCertificate()">â• Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø§Ø¯Ø©</button>
    </div>

    <table>
      <thead>
        <tr><th>Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙØ§Ø°</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th><th class="no-print">Ø§Ù„Ù…Ù„Ù</th>
        </tr>
      </thead>
      <tbody id="certificateTableBody"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>ğŸ§­ Ù…Ù„Ø®Øµ Sea Time</h3>
    <p class="no-print">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„Ø§Øª: <span id="sea-moves">0</span></p>
    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø±: <span id="sea-total-days">0</span> ÙŠÙˆÙ…</p>
  </div>

  <div class="section" id="service-section">
    <h3>ğŸ“…  Ø³Ø¬Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h3>  
    <p style="font-weight: bold; color: #0d47a1;">ğŸ“Š Average Evaluation: <span id="average-evaluation">â€”</span></p>
    <div class="no-print" style="margin-bottom: 10px; text-align: left;">
      <label for="filterType">ğŸ“‚ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:</label>
      <select id="filterType" onchange="filterServiceTable()">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="service">Ø§Ù„ØµØ¹ÙˆØ¯</option>
        <option value="rest">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</option>
      </select>
    </div>    
    <div class="form-inline no-print">
      <select id="service-ship">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ù‚Ù„Ø©</option>
      </select>
      <select id="service-status">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
      </select>
      <input type="date" id="service-join" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
      <input type="date" id="service-leave" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
      <select id="service-rank">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>
      </select>
      <button onclick="addServiceEntry()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
    </div>    
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù†Ø§Ù‚Ù„Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ù…Ù† ØªØ§Ø±ÙŠØ®</th>
          <th>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ø¯Ø©</th>
          <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
          <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th> <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
          <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>      
      <tbody id="seaTimeProfileBody"></tbody>
    </table>
  </div>
  
  <script>
    let fullHistory = []; // Ø¶Ø±ÙˆØ±ÙŠ ØªÙƒÙˆÙ† Ù…ØªØ¹Ø±ÙØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù„
    const SUPABASE_URL = "https://hhglsrugbayccdboasaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZ2xzcnVnYmF5Y2NkYm9hc2FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NTEzMDIsImV4cCI6MjA1ODUyNzMwMn0._wHDCT00aa4IQYJNzpL4hjcz9BURslqJt9OUtfxjxlM";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get("id");

    async function loadEmployeeProfile() {
  if (!employeeId) return;

  const { data: crew } = await sb.from("crew_list").select("*").eq("id", employeeId).single();
  if (crew) {
    document.getElementById("profile-name").textContent = crew.name;
    document.getElementById("profile-rank").textContent = crew.rank;
    document.getElementById("profile-status").textContent = crew.status;
    document.getElementById("profile-ship").textContent = crew.ship;
    document.getElementById("profile-phone1").value = crew.phone1 || "";
    document.getElementById("profile-phone2").value = crew.phone2 || "";
    document.getElementById("profile-address").value = crew.address || "";
  }
  if (crew.image_url) {
    document.getElementById("profile-image").src = crew.image_url;
  }

  const { data: history } = await sb.from("history").select("*").eq("employee_id", employeeId);
fullHistory = history || [];
renderServiceTable(fullHistory);

loadCertificates();
}

async function updateEmployeeInfo() {
  const phone1 = document.getElementById("profile-phone1").value.trim();
  const phone2 = document.getElementById("profile-phone2").value.trim();
  const address = document.getElementById("profile-address").value.trim();

  const { error } = await sb
    .from("crew_list")
    .update({ phone1, phone2, address })
    .eq("id", employeeId);

  if (error) {
    alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + error.message);
  } else {
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­");
  }
}

  async function deleteServiceEntry(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")) return;
    await sb.from("history").delete().eq("id", id);
    loadEmployeeProfile();
  }

  async function editServiceEntry(button, id) {
  const row = button.closest("tr");
  const cells = row.querySelectorAll("td");
  const [shipCell, statusCell, joinCell, leaveCell, durationCell, rankCell, evalCell] = cells;

  if (button.textContent.includes("âœï¸")) {
    shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = true;

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ù„Ù‰ dropdown
const currentEval = evalCell.textContent.trim().split(" ")[0];
evalCell.innerHTML = `
  <select id="eval-select">
    <option value="">â€”</option>
    <option value="1" ${currentEval === "1" ? "selected" : ""}>1 - Excellent</option>
    <option value="2" ${currentEval === "2" ? "selected" : ""}>2 - Very Good</option>
    <option value="3" ${currentEval === "3" ? "selected" : ""}>3 - Good</option>
    <option value="4" ${currentEval === "4" ? "selected" : ""}>4 - Average</option>
    <option value="5" ${currentEval === "5" ? "selected" : ""}>5 - Poor</option>
  </select>
`;
    shipCell.focus();
    button.textContent = "ğŸ’¾";
    button.classList.remove("edit");
  } else {
    shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = false;
    button.textContent = "âœï¸";
    button.classList.add("edit");

    const joinValue = joinCell.textContent.trim();
    const leaveValue = leaveCell.textContent.trim();

    const joinDate = joinValue === "" ? null : joinValue;
    const leaveDate = leaveValue === "" ? null : leaveValue;

    const evalValue = document.getElementById("eval-select").value;

const { error } = await sb.from("history").update({
  ship: shipCell.textContent.trim(),
  status: statusCell.textContent.trim(),
  join_date: joinDate,
  leave_date: leaveDate,
  duration: calculateDuration(joinDate, leaveDate),
  rank: rankCell.textContent.trim(),
  evaluation: evalValue ? parseInt(evalValue) : null
}).eq("id", id);

    if (error) {
      alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
    } else {
      loadEmployeeProfile(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    }
  }
}

    async function loadCertificates() {
  const { data: certs } = await sb.from("certificates").select("*").eq("employee_id", employeeId);
  const today = new Date();

  console.log(certs);
  document.getElementById("certificateTableBody").innerHTML = certs.map(cert => {
    let bgColor = "";
    let expiryDisplay = cert.expiry_date;

    if (cert.expiry_date) {
      const expiry = new Date(cert.expiry_date);
      const diffDays = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));

      if (!isNaN(diffDays)) {
        if (diffDays < 0) {
          bgColor = "background-color: #fff9c4;";
        } else if (diffDays <= 60) {
          bgColor = "background-color: #ffcdd2;";
        }
      }
    }

    return `<tr>
      <td contenteditable="false">${cert.name}</td>
      <td contenteditable="false">${cert.issue_date || ""}</td>
      <td contenteditable="false" style="${bgColor}">${expiryDisplay || ""}</td>
      <td class="actions no-print">
        <button class="edit" onclick="editCertificate(this, '${cert.id}')">âœï¸</button>
        <button class="delete" onclick="deleteCertificate('${cert.id}')">ğŸ—‘ï¸</button>
      </td>
      <td class="no-print">
  <div style="display: flex; flex-direction: column; align-items: start; gap: 5px;">
    <label style="cursor: pointer; color: #1a237e; font-weight: bold;">
      ğŸ“¤ Ø±ÙØ¹
      <input type="file" accept=".pdf,.png,.jpg" style="display: none"
             onchange="uploadCertificateFile('${cert.id}', this.files[0])" />
    </label>
    ${cert.document_url ? `
      <div>
        <a href="${cert.document_url}" target="_blank" style="margin-left: 10px;">ğŸ“ Ø¹Ø±Ø¶</a>
        <a href="${cert.document_url}" download>â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>
        <button onclick="deleteCertificateDocument('${cert.id}', '${cert.document_url}')" style="background: transparent; color: red; border: none; cursor: pointer;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</button>
      </div>
    ` : ''}
  </div>
</td>
    </tr>`;
  }).join('');
}

    async function addCertificate() {
      const name = document.getElementById("cert-name").value.trim();
      const issue = document.getElementById("cert-issue").value;
      const expiry = document.getElementById("cert-expiry").value;
      if (!name || !issue || !expiry) {
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
      }

      const { error } = await sb.from("certificates").insert({
        employee_id: employeeId,
        name,
        issue_date: issue,
        expiry_date: expiry
      });

      if (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + error.message);
      } else {
        document.getElementById("cert-name").value = "";
        document.getElementById("cert-issue").value = "";
        document.getElementById("cert-expiry").value = "";
        loadCertificates();
      }
    }

    async function deleteCertificate(id) {
  const confirmDelete = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŸ");
  if (!confirmDelete) return;

  // ğŸ‘‡ Ø£ÙˆÙ„ Ø´ÙŠ Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ø­ØªÙ‰ Ù†Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù
  const { data, error: fetchError } = await sb
    .from("certificates")
    .select("document_url")
    .eq("id", id)
    .single();

  if (fetchError) {
    alert("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: " + fetchError.message);
    return;
  }

  // Ù†Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
  if (data.document_url) {
    const filePath = data.document_url.split("/").pop(); // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·

    const { error: deleteFileError } = await sb
      .storage
      .from("certificates-docs")
      .remove([filePath]);

    if (deleteFileError) {
      alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†: " + deleteFileError.message);
      return;
    }
  }

  // âœ… Ø¨Ø¹Ø¯Ù‡Ø§ Ù†Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const { error: deleteRowError } = await sb
    .from("certificates")
    .delete()
    .eq("id", id);

  if (deleteRowError) {
    alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + deleteRowError.message);
    return;
  }

  alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
  loadCertificates(); // Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
}

function calculateDuration(startDate, endDate) {
  if (!startDate || !endDate) return 0;
  const start = new Date(startDate);
  const end = new Date(endDate);
  if (isNaN(start) || isNaN(end)) return 0;
  return Math.max(0, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
}

    async function editCertificate(button, id) {
      const row = button.closest("tr");
      const cells = row.querySelectorAll("td");
      const nameCell = cells[0];
      const issueCell = cells[1];
      const expiryCell = cells[2];

      if (button.textContent.includes("âœï¸")) {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = true;
        nameCell.focus();
        button.textContent = "ğŸ’¾";
        button.classList.remove("edit");
      } else {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = false;
        button.textContent = "âœï¸";
        button.classList.add("edit");

        const { error } = await sb.from("certificates").update({
          name: nameCell.textContent.trim(),
          issue_date: issueCell.textContent.trim(),
          expiry_date: expiryCell.textContent.trim()
        }).eq("id", id);

        if (error) {
  alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
} else {
  loadCertificates();
}
      }
    }

    function smartDuration(joinDateStr, leaveDateStr, status, fallbackEndDate = null) {
  const today = new Date();
  const join = joinDateStr ? new Date(joinDateStr) : null;
  const leave = leaveDateStr ? new Date(leaveDateStr) : null;
  const fallback = fallbackEndDate ? new Date(fallbackEndDate) : today;

  if (join && leave) {
    return calculateDuration(join, leave); // âœ… Ù…Ù† ØµØ¹ÙˆØ¯ Ø¥Ù„Ù‰ Ù†Ø²ÙˆÙ„
  }

  if (status === "Ù…Ù„ØªØ­Ù‚" && join && !leave) {
    return calculateDuration(join, fallback); // âœ… ØµØ§Ø¹Ø¯ ÙˆÙ…Ø¨Ø¹Ø¯Ù‡ Ù†Ø²Ù„
  }

  if (status === "Ø§Ø³ØªØ±Ø§Ø­Ø©" && leave && !join) {
    return calculateDuration(leave, fallback); // âœ… Ù†Ø²Ù„ ÙˆØ¨Ø§Ù‚ÙŠ Ù…Ø³ØªØ±Ø§Ø­
  }

  return 0;
}

async function addServiceEntry() {
  const ship = document.getElementById("service-ship").value.trim();
  const status = document.getElementById("service-status").value.trim();
  const join_date = document.getElementById("service-join").value;
  const leave_date = document.getElementById("service-leave").value;
  const rank = document.getElementById("service-rank").value.trim();

  if (!ship || !status || !join_date || !rank) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„Ù†Ø§Ù‚Ù„Ø©ØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ù…Ù† ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø±ØªØ¨Ø©");
    return;
  }

  // ğŸ§  Ù†Ø­Ø³Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø©
  let dynamicLeaveDate = leave_date || null;

  // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
  let duration = 0;
  if (join_date && dynamicLeaveDate) {
    duration = calculateDuration(join_date, dynamicLeaveDate);
  } else if (join_date && !dynamicLeaveDate) {
    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙƒÙ…Ù„ Ø§Ù„ÙØªØ±Ø© Ø¨Ø¹Ø¯ØŒ Ù†Ø­Ø³Ø¨Ù‡Ø§ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
    duration = calculateDuration(join_date, new Date().toISOString().split("T")[0]);
  }

  const { error } = await sb.from("history").insert({
    employee_id: employeeId,
    ship,
    status,
    join_date,
    leave_date: dynamicLeaveDate,
    rank,
    duration
  });

  if (error) {
    alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©: " + error.message);
  } else {
    // Ù†ÙØ±Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    document.getElementById("service-ship").value = "";
    document.getElementById("service-status").value = "";
    document.getElementById("service-join").value = "";
    document.getElementById("service-leave").value = "";
    document.getElementById("service-rank").value = "";

    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­");
    loadEmployeeProfile(); // ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  }
}

async function uploadEmployeeImage() {
  const fileInput = document.getElementById("upload-image");
  const file = fileInput.files[0];

  if (!file) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©");
    return;
  }

  // ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© (300KB = 300 * 1024 bytes)
  if (file.size > 300 * 1024) {
    alert("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 300KBØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ±.");
    return;
  }

  const fileExt = file.name.split('.').pop();
  const fileName = `${employeeId}.${fileExt}`;
  const filePath = `employees/${fileName}`;

  const { error: uploadError } = await sb.storage
    .from("employees")
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: " + uploadError.message);
    return;
  }

  const { data } = supabase.storage
    .from("employees")
    .getPublicUrl(filePath);

  const imageUrl = data.publicUrl;

  const { error: updateError } = await sb
    .from("crew_list")
    .update({ image_url: imageUrl })
    .eq("id", employeeId);

  if (updateError) {
    alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: " + updateError.message);
  } else {
    document.getElementById("profile-image").src = imageUrl;
    alert("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
  }
}

async function deleteEmployeeImage() {
  const fileExt = "jpg"; // Ø¥Ø°Ø§ ØªØ¶Ù…Ù† Ø§Ù…ØªØ¯Ø§Ø¯ Ù…Ø¹ÙŠÙ‘Ù†
  const filePath = `${employeeId}.${fileExt}`;

  // Ø­Ø°Ù Ù…Ù† Supabase Storage
  const { error: deleteError } = await sb.storage
    .from("employees")
    .remove([filePath]);

  if (deleteError) {
    alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©: " + deleteError.message);
    return;
  }

  // Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const { error: updateError } = await sb
    .from("crew_list")
    .update({ image_url: null })
    .eq("id", employeeId);

  if (updateError) {
    alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù: " + updateError.message);
    return;
  }

  document.getElementById("profile-image").src = "";
  alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
}

document.addEventListener("DOMContentLoaded", () => {
  loadEmployeeProfile();
  loadServiceDropdowns();
});

const rankOrder = [
  "Ø±Ø¨Ø§Ù†",
  "Ø±Ø¦ÙŠØ³ Ø¶Ø¨Ø§Ø·",
  "Ø±Ø¦ÙŠØ³ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†",
  "Ø¶Ø§Ø¨Ø· Ø«Ø§Ù†ÙŠ",
  "Ø¶Ø§Ø¨Ø· Ø«Ø§Ù„Ø«",
  "Ø¶Ø§Ø¨Ø· Ø±Ø§Ø¨Ø¹",
  "Ù…Ù‡Ù†Ø¯Ø³ Ø«Ø§Ù†ÙŠ",
  "Ù…Ù‡Ù†Ø¯Ø³ Ø«Ø§Ù„Ø«",
  "Ù…Ù‡Ù†Ø¯Ø³ Ø±Ø§Ø¨Ø¹",
  "Ù…Ù‡Ù†Ø¯Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¡",
  "Ø±Ù‚ÙŠØ¨ Ø³Ø·Ø­Ø©",
  "Ù…Ø±Ø§Ù‚Ø¨ Ù…Ø¶Ø®Ø©",
  "Ø¨Ø­Ø§Ø±",
  "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ",
  "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ",
  "Ù…Ø±Ø§Ù‚Ø¨ ØºØ±ÙØ© Ù…Ø§ÙƒÙ†Ø©",
  "Ø·Ø¨Ø§Ø®",
  "Ù…Ø£Ù…ÙˆØ± Ù…Ø§Ø¦Ø¯Ø©",
];


async function loadServiceDropdowns() {
  const { data: crew } = await sb.from("crew_list").select("ship, status, rank");
  if (!crew) return;

  // Ù†Ø­Ø°Ù Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„ Ø´ÙŠ
  const shipSelect = document.getElementById("service-ship");
  const statusSelect = document.getElementById("service-status");
  const rankSelect = document.getElementById("service-rank");

  shipSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ù‚Ù„Ø©</option>';
  statusSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>';
  rankSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>';

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
  const ships = [...new Set(crew.map(c => c.ship).filter(Boolean))];
  const statuses = [...new Set(crew.map(c => c.status).filter(Boolean))];

  ships.sort().forEach(ship => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = ship;
    shipSelect.appendChild(opt);
  });

  statuses.sort().forEach(status => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = status;
    statusSelect.appendChild(opt);
  });

  rankOrder.forEach(rank => {
  const opt = document.createElement("option");
  opt.value = opt.textContent = rank;
  rankSelect.appendChild(opt);
});
}

async function uploadEmployeeImage() {
  const fileInput = document.getElementById("upload-image");
  const file = fileInput.files[0];

  if (!file) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©");
    return;
  }

  if (file.size > 300 * 1024) {
    alert("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 300KB");
    return;
  }

  const fileExt = file.name.split('.').pop();
  const fileName = `${employeeId}.${fileExt}`; // Ø§Ø³Ù… ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù„Ø¯
  const filePath = fileName;

  const { error: uploadError } = await sb.storage
    .from("employees")
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: " + uploadError.message);
    return;
  }

  const { data } = supabase.storage
    .from("employees")
    .getPublicUrl(filePath);

  const imageUrl = data?.publicUrl;

  const { error: updateError } = await sb
    .from("crew_list")
    .update({ image_url: imageUrl })
    .eq("id", employeeId);

  if (updateError) {
    alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: " + updateError.message);
  } else {
    document.getElementById("profile-image").src = imageUrl;
    alert("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
  }
}

function renderServiceTable(data, fullList = fullHistory) {
  let totalDays = 0;

  // Ù†Ø±ØªØ¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
  fullList.sort((a, b) => {
    const dateA = new Date(a.join_date || a.leave_date || "1900-01-01");
    const dateB = new Date(b.join_date || b.leave_date || "1900-01-01");
    return dateB - dateA;
  });

  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ data
  data.sort((a, b) => {
    const dateA = new Date(a.join_date || a.leave_date || "1900-01-01");
    const dateB = new Date(b.join_date || b.leave_date || "1900-01-01");
    return dateB - dateA;
  });

  console.log("ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ù…Ø±ØªØ¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:");
  data.forEach((row, i) => {
    console.log(`${i + 1}. Ø§Ù„Ø­Ø§Ù„Ø©: ${row.status}, Ø§Ù„Ù†Ø§Ù‚Ù„Ø©: ${row.ship}, Ù…Ù†: ${row.join_date}, Ø¥Ù„Ù‰: ${row.leave_date}`);
  });

  document.getElementById("seaTimeProfileBody").innerHTML = data.map((entry) => {
    const fullIndex = fullList.findIndex(e => e.id === entry.id);
    const nextEntry = fullList[fullIndex - 1];
    const prevEntry = fullList[fullIndex + 1];

    const duration = getServiceDuration(entry, nextEntry, prevEntry);

    if (entry.ship !== "Ø§Ø³ØªØ±Ø§Ø­Ø©") {
      totalDays += duration;
    }

    console.log(`ğŸ”¢ [${entry.ship}] Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© = ${duration} ÙŠÙˆÙ…`);

    return `
  <tr>
    <td>${entry.ship}</td>
    <td>${entry.status}</td>
    <td>${entry.join_date || ""}</td>
    <td>${entry.leave_date || ""}</td>
    <td>${duration} ÙŠÙˆÙ…</td>
    <td>${entry.rank || "â€”"}</td>
    <td>${entry.evaluation ? `${entry.evaluation} - ${evaluationText(entry.evaluation)}` : "â€”"}</td>
    <td class="actions no-print">
      <button class="edit" onclick="editServiceEntry(this, '${entry.id}')">âœï¸</button>
      <button class="delete" onclick="deleteServiceEntry('${entry.id}')">ğŸ—‘ï¸</button>
    </td>
  </tr>
`;
  }).join("");

  // ğŸ§® Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
const ratings = data.map(e => e.evaluation).filter(v => v !== null && v !== undefined).map(Number);
const avg = ratings.length ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(2) : null;

document.getElementById("average-evaluation").textContent =
  avg ? `${avg} - ${evaluationText(Math.round(avg))}` : "â€”";
  document.getElementById("sea-total-days").textContent = totalDays;
  document.getElementById("sea-moves").textContent = data.length;
}

function evaluationText(score) {
  switch (parseInt(score)) {
    case 1: return "Excellent";
    case 2: return "Very Good";
    case 3: return "Good";
    case 4: return "Average";
    case 5: return "Poor";
    default: return "â€”";
  }
}

function getServiceDuration(entry, nextEntry, prevEntry) {
  const today = new Date();

  const join = entry.join_date ? new Date(entry.join_date) : null;
  const leave = entry.leave_date ? new Date(entry.leave_date) : null;
  const nextJoin = nextEntry?.join_date ? new Date(nextEntry.join_date) : null;

  // âœ… Ù…ÙˆØ¸Ù Ø¹Ù„Ù‰ Ù†Ø§Ù‚Ù„Ø©ØŒ Ø¹Ù†Ø¯Ù‡ join Ùˆ leave â†’ Ù†Ø­Ø³Ø¨ Ø¨ÙŠÙ†Ù‡Ù…
  if (entry.ship !== "Ø§Ø³ØªØ±Ø§Ø­Ø©" && join && leave) {
    const duration = calculateDuration(join, leave);
    console.log(`ğŸŸ¢ Ù…ÙˆØ¸Ù (ØµØ¹ÙˆØ¯ ÙˆÙ†Ø²ÙˆÙ„): Ù…Ù† ${join.toDateString()} Ø¥Ù„Ù‰ ${leave.toDateString()} = ${duration} ÙŠÙˆÙ…`);
    return duration;
  }

  if (entry.ship !== "Ø§Ø³ØªØ±Ø§Ø­Ø©" && join && !leave && nextEntry?.ship === "Ø§Ø³ØªØ±Ø§Ø­Ø©" && nextEntry?.leave_date) {
  const end = new Date(nextEntry.leave_date);
  const duration = calculateDuration(join, end);
  console.log(`ğŸŸ¢ ØµØ¹ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ø³ØªØ±Ø§Ø­Ø©: Ù…Ù† ${join.toDateString()} Ø¥Ù„Ù‰ ${end.toDateString()} = ${duration} ÙŠÙˆÙ…`);
  return duration;
}

  // âœ… Ù…ÙˆØ¸Ù Ø¹Ù„Ù‰ Ù†Ø§Ù‚Ù„Ø©ØŒ Ø¹Ù†Ø¯Ù‡ join ÙÙ‚Ø· (Ù…Ø§ Ù†Ø²Ù„ Ø¨Ø¹Ø¯)
  if (entry.ship !== "Ø§Ø³ØªØ±Ø§Ø­Ø©" && join && !leave) {
    const duration = calculateDuration(join, today);
    console.log(`ğŸŸ¢ Ù…ÙˆØ¸Ù Ù…Ù„ØªØ­Ù‚: Ù…Ù† ${join.toDateString()} Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… = ${duration} ÙŠÙˆÙ…`);
    return duration;
  }

  // âœ… Ø§Ø³ØªØ±Ø§Ø­Ø©ØŒ Ø¹Ù†Ø¯Ù‡ leave (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©) ÙˆØµØ¹ÙˆØ¯ Ø¨Ø¹Ø¯Ù‡
  if (entry.ship === "Ø§Ø³ØªØ±Ø§Ø­Ø©" && leave && nextJoin) {
    const duration = calculateDuration(leave, nextJoin);
    console.log(`ğŸŸ  Ø§Ø³ØªØ±Ø§Ø­Ø©: Ù…Ù† ${leave.toDateString()} Ø¥Ù„Ù‰ ${nextJoin.toDateString()} = ${duration} ÙŠÙˆÙ…`);
    return duration;
  }

  // âœ… Ø§Ø³ØªØ±Ø§Ø­Ø© Ø­Ø§Ù„ÙŠØ©
  if (entry.ship === "Ø§Ø³ØªØ±Ø§Ø­Ø©" && leave && !nextJoin) {
    const duration = calculateDuration(leave, today);
    console.log(`ğŸŸ¡ Ø§Ø³ØªØ±Ø§Ø­Ø© Ø¬Ø§Ø±ÙŠØ©: Ù…Ù† ${leave.toDateString()} Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… = ${duration} ÙŠÙˆÙ…`);
    return duration;
  }

  return 0;
}

function filterServiceTable() {
  const type = document.getElementById("filterType").value;

  // ğŸ” Ù†Ø±ØªØ¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¨Ù„ ÙƒÙ„ Ø´ÙŠ
  const sortedHistory = [...fullHistory].sort((a, b) => {
    const dateA = new Date(a.join_date || a.leave_date || "1900-01-01");
    const dateB = new Date(b.join_date || b.leave_date || "1900-01-01");
    return dateA - dateB;
  });

  // âœ… Ù†Ø³ÙˆÙŠ Ù†Ø³Ø®Ø© ÙÙ„ØªØ±Ø© ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
  let filtered = [...sortedHistory];
  if (type === "service") {
    filtered = sortedHistory.filter(e => e.ship !== "Ø§Ø³ØªØ±Ø§Ø­Ø©");
  } else if (type === "rest") {
    filtered = sortedHistory.filter(e => e.ship === "Ø§Ø³ØªØ±Ø§Ø­Ø©");
  }

  // âœ… Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù€ fullHistory Ù„Ù„Ø±Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­
  renderServiceTable(filtered, sortedHistory);
}

function printSection(sectionId) {
  const section = document.getElementById(sectionId);
  const employeeName = document.getElementById("profile-name").textContent;
  const profileImage = document.getElementById("profile-image").src;
  const originalContent = document.body.innerHTML;

  const clonedSection = section.cloneNode(true);

  if (sectionId === 'service-section') {
    const seaSummary = document.querySelectorAll(".section")[2];
    const summaryClone = seaSummary.cloneNode(true);
    clonedSection.prepend(summaryClone);
  }

  // âœ… Ù‡Ù†Ø§ Ù†ØªØ­ÙƒÙ… Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  const includeEval = document.getElementById("toggle-evaluation-print")?.checked;

  if (!includeEval) {
    const evalColumns = clonedSection.querySelectorAll("td:nth-child(7), th:nth-child(7)");
    evalColumns.forEach(el => el.remove());

    const avgEval = clonedSection.querySelector("#average-evaluation");
    if (avgEval) {
      avgEval.closest("p")?.remove();
    }
  }

  const printableContent = `
    <div style="font-family: 'Cairo', sans-serif; direction: rtl; padding: 20px;">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        ${profileImage ? `<img src="${profileImage}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #aaa;">` : ''}
        <h2 style="margin: 0; color: #1a237e;">ğŸ§¾ ${employeeName}</h2>
      </div>
      <hr style="margin: 20px 0;">
      ${clonedSection.innerHTML}
    </div>
  `;

  document.body.innerHTML = printableContent;
  window.print();
  document.body.innerHTML = originalContent;
  location.reload();
}

async function clearCertificateUrl(certId) {
  const { error } = await sb
    .from("certificates")
    .update({ document_url: null })
    .eq("id", certId);

  if (error) {
    console.log("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©:", error.message);
  } else {
    console.log("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©");
  }
}

async function deleteCertificateDocument(certId, documentUrl) {
  const fileName = documentUrl.split('/').pop(); // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·

  // 1ï¸âƒ£ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
  const { error: deleteStorageError } = await sb
    .storage
    .from('certificates-docs')
    .remove([fileName]);

  if (deleteStorageError) {
    alert("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†: " + deleteStorageError.message);
    return;
  }

  // 2ï¸âƒ£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·
  const { error: updateDbError } = await sb
    .from("certificates")
    .update({ document_url: null })
    .eq("id", certId);

  if (updateDbError) {
    alert("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + updateDbError.message);
    return;
  }

  alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­");
  loadCertificates(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
}
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get("id");

    if (!employeeId) return;

    const { data, error } = await sb
      .from("crew_list")
      .select("is_complete")
      .eq("id", employeeId)
      .single();

    const btn = document.getElementById("mark-incomplete-btn");
    const msg = document.getElementById("completion-status-msg");

    if (error || !data) {
      console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„:", error);
      if (btn) btn.style.display = "none";
      return;
    }

    if (data.is_complete === false) {
      msg.textContent = "âš  Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙØ¹Ù„Ù‘ÙÙ… ÙƒÙ€ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„";
    }

    const { data: userData } = await sb.auth.getUser();
    const email = userData?.user?.email || "";

    // âœ… ØªØ£ÙƒØ¯ Ø§Ù„Ø²Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ addEventListener
    if (btn) {
      btn.addEventListener("click", async () => {
        const { error: updateError } = await sb
          .from("crew_list")
          .update({ is_complete: false })
          .eq("id", employeeId);

        if (updateError) {
          alert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù");
          console.error(updateError);
        } else {
          alert("âœ… ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù…Ù„Ù ÙƒÙ€ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„");
          msg.textContent = "âš  Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙØ¹Ù„Ù‘ÙÙ… ÙƒÙ€ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„";
          btn.disabled = true;
        }
      });
    }
  }); // âœ… Ù‡Ø°Ø§ ÙƒØ§Ù† Ù†Ø§Ù‚Øµ
</script>

<script>
async function setupCompletionToggle(employeeId) {
  const button = document.getElementById("toggle-complete-btn");
  if (!button) return;

  // âœ… Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù…Ù† Supabase
  const { data, error } = await sb
    .from("crew_list")
    .select("is_complete")
    .eq("id", employeeId)
    .single();

  if (error || !data) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„:", error);
    button.textContent = "Ø®Ø·Ø£!";
    button.disabled = true;
    return;
  }

  // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  updateToggleButtonUI(button, data.is_complete);

  // âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·: Ù†Ù‚Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙ†Ø­Ø¯Ø«
  button.addEventListener("click", async () => {
    const newState = !button.classList.contains("complete");

    const { error: updateError } = await sb
      .from("crew_list")
      .update({ is_complete: newState })
      .eq("id", employeeId);

    if (updateError) {
      alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
      return;
    }

    updateToggleButtonUI(button, newState);
  });
}

// âœ… Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
function updateToggleButtonUI(button, isComplete) {
  if (isComplete) {
    button.textContent = "âœ… Ù…ÙƒØªÙ…Ù„";
    button.classList.add("complete");
    button.classList.remove("incomplete");
  } else {
    button.textContent = "âŒ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„";
    button.classList.add("incomplete");
    button.classList.remove("complete");
  }
}

// âœ… Ù†ÙØ° Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (ØªØ£ÙƒØ¯ employeeId Ø¬Ø§Ù‡Ø²)
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const employeeId = urlParams.get("id");
  if (employeeId) {
    setupCompletionToggle(employeeId);
  }
});
</script>

</body>
</html>