<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ููู ุงูููุธู ุงูุจุญุฑู</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      padding: 20px;
      background-color: #f0f4f8;
      direction: rtl;
    }
    h2 {
      text-align: center;
      color: #1a237e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      text-align: center;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #90caf9;
      color: #0d47a1;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-inline {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .form-inline input {
      padding: 5px;
      flex: 1;
    }
    .form-inline button {
      padding: 6px 20px;
      background-color: #1a237e;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    .actions button {
      margin: 2px;
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .actions .edit {
      background-color: #ffb300;
      color: white;
    }
    .actions .delete {
      background-color: #d32f2f;
      color: white;
    }
    @media print {
  .print-buttons,
  .no-print {
    display: none !important;
  }
}
  </style>
</head>
<body>
  <h2>๐ ููู ุงูููุธู ุงูุจุญุฑู</h2>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="export-certificates.html" target="_blank">
      <button style="padding: 10px 30px; background-color: #0d47a1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
        ๐ฅ ุชุตุฏูุฑ ุดูุงุฏุงุช ุงูุทุงูู
      </button>
    </a>
  </div>  

  <div class="print-buttons" style="text-align: center; margin-bottom: 20px;">
    <button onclick="window.print()" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ๐จ๏ธ ุทุจุงุนุฉ ุงูููู ุงููุงูู
    </button>
    <button onclick="printSection('certificates-section')" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ๐จ๏ธ ุทุจุงุนุฉ ุงูุดูุงุฏุงุช ุงูุจุญุฑูุฉ
    </button>
    <button onclick="printSection('service-section')" style="padding: 10px 30px; background-color: #1a237e; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
      ๐จ๏ธ ุทุจุงุนุฉ ุณุฌู ุงูุฎุฏูุฉ ุงูุจุญุฑูุฉ
    </button>
  </div>  

  <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
    <div>
      <img id="profile-image" src="" alt="ุตูุฑุฉ ุงูููุธู" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid #ccc;">
    </div>
    <div class="no-print">
      <input type="file" id="upload-image" accept="image/*">
      <button onclick="uploadEmployeeImage()">๐ค ุฑูุน ุงูุตูุฑุฉ</button>
      <button id="delete-image-btn" onclick="deleteEmployeeImage()" style="background-color: #d32f2f; color: white; margin-right: 10px;">๐๏ธ ุญุฐู ุงูุตูุฑุฉ</button>
      <p style="font-size: 14px; color: #555; margin-top: 5px;">
        ๐ธ ููุถู ุฑูุน ุตูุฑุฉ ุจุญุฌู ุฃูู ูู 500x500 ุจูุณูุ ูุฃูู ูู 300 ููููุจุงูุช.
      </p>
    </div>    
  </div>  

  <div class="section">
    <p><strong>๐ค ุงูุงุณู:</strong> <span id="profile-name">---</span></p>
    <p><strong>๐๏ธ ุงูุฑุชุจุฉ:</strong> <span id="profile-rank">---</span></p>
    <p><strong>โ ุงูุญุงูุฉ:</strong> <span id="profile-status">---</span></p>
    <p><strong>โด๏ธ ุงููุงููุฉ:</strong> <span id="profile-ship">---</span></p>
  </div>

  <div class="section" id="certificates-section">
    <h3>๐ ุงูุดูุงุฏุงุช ุงูุจุญุฑูุฉ</h3>  

    <div class="form-inline no-print">
      <input type="text" id="cert-name" placeholder="ุงุณู ุงูุดูุงุฏุฉ">
      <input type="date" id="cert-issue" placeholder="ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ">
      <input type="date" id="cert-expiry" placeholder="ุชุงุฑูุฎ ุงูููุงุฐ">
      <button onclick="addCertificate()">โ ุฅุถุงูุฉ ุดูุงุฏุฉ</button>
    </div>

    <table>
      <thead>
        <tr><th>ุงุณู ุงูุดูุงุฏุฉ</th><th>ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ</th><th>ุชุงุฑูุฎ ุงูููุงุฐ</th><th class="no-print">ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody id="certificateTableBody"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>๐งญ ููุฎุต Sea Time</h3>
    <p>ุนุฏุฏ ุงูุชูููุงุช: <span id="sea-moves">0</span></p>
    <p>ุฅุฌูุงูู ุงูุฃูุงู ูู ุงูุจุญุฑ: <span id="sea-total-days">0</span> ููู</p>
  </div>

  <div class="section" id="service-section">
    <h3>๐  ุณุฌู ุงูุฎุฏูุฉ ุงูุจุญุฑูุฉ</h3>  
    <div class="no-print" style="margin-bottom: 10px; text-align: left;">
      <label for="filterType">๐ ุชุตููุฉ ุญุณุจ ุงูููุน:</label>
      <select id="filterType" onchange="filterServiceTable()">
        <option value="all">ุงููู</option>
        <option value="service">ุงูุตุนูุฏ</option>
        <option value="rest">ุงูุงุณุชุฑุงุญุฉ</option>
      </select>
    </div>    
    <div class="form-inline no-print">
      <select id="service-ship">
        <option value="">ุงุฎุชุฑ ุงููุงููุฉ</option>
      </select>
      <select id="service-status">
        <option value="">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
      </select>
      <input type="date" id="service-join" placeholder="ูู ุชุงุฑูุฎ">
      <input type="date" id="service-leave" placeholder="ุฅูู ุชุงุฑูุฎ">
      <select id="service-rank">
        <option value="">ุงุฎุชุฑ ุงูุฑุชุจุฉ</option>
      </select>
      <button onclick="addServiceEntry()">โ ุฅุถุงูุฉ ุฎุฏูุฉ</button>
    </div>    
    <table>
      <thead>
        <tr>
          <th>ุงููุงููุฉ</th><th>ุงูุญุงูุฉ</th><th>ูู ุชุงุฑูุฎ</th><th>ุฅูู ุชุงุฑูุฎ</th><th>ุงููุฏุฉ</th><th>ุงูุฑุชุจุฉ</th><th class="no-print">ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody id="seaTimeProfileBody"></tbody>
    </table>
  </div>
  
  <script>
    let fullHistory = []; // ุถุฑูุฑู ุชููู ูุชุนุฑูุฉ ุฎุงุฑุฌ ุงูุฏูุงู
    const SUPABASE_URL = "https://hhglsrugbayccdboasaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZ2xzcnVnYmF5Y2NkYm9hc2FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NTEzMDIsImV4cCI6MjA1ODUyNzMwMn0._wHDCT00aa4IQYJNzpL4hjcz9BURslqJt9OUtfxjxlM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get("id");

    async function loadEmployeeProfile() {
  if (!employeeId) return;

  const { data: crew } = await supabase.from("crew_list").select("*").eq("id", employeeId).single();
  if (crew) {
    document.getElementById("profile-name").textContent = crew.name;
    document.getElementById("profile-rank").textContent = crew.rank;
    document.getElementById("profile-status").textContent = crew.status;
    document.getElementById("profile-ship").textContent = crew.ship;
  }
  if (crew.image_url) {
    document.getElementById("profile-image").src = crew.image_url;
  }

  const { data: history } = await supabase.from("history").select("*").eq("employee_id", employeeId);
fullHistory = history || [];
renderServiceTable(fullHistory);

loadCertificates();
}

  async function deleteServiceEntry(id) {
    if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฎุฏูุฉุ")) return;
    await supabase.from("history").delete().eq("id", id);
    loadEmployeeProfile();
  }

  async function editServiceEntry(button, id) {
    const row = button.closest("tr");
    const cells = row.querySelectorAll("td");
    const [shipCell, statusCell, joinCell, leaveCell, durationCell, rankCell] = cells;

    if (button.textContent.includes("โ๏ธ")) {
      shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = true;
      shipCell.focus();
      button.textContent = "๐พ";
      button.classList.remove("edit");
    } else {
      shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = false;
      button.textContent = "โ๏ธ";
      button.classList.add("edit");

      const { error } = await supabase.from("history").update({
        ship: shipCell.textContent.trim(),
        status: statusCell.textContent.trim(),
        join_date: joinCell.textContent.trim(),
        leave_date: leaveCell.textContent.trim(),
        duration: calculateDuration(joinCell.textContent.trim(), leaveCell.textContent.trim()),
        rank: rankCell.textContent.trim()
      }).eq("id", id);

      if (error) alert("ูุดู ุงูุชุนุฏูู: " + error.message);
      else loadEmployeeProfile();
    }
  }

    async function loadCertificates() {
  const { data: certs } = await supabase.from("certificates").select("*").eq("employee_id", employeeId);
  const today = new Date();

  document.getElementById("certificateTableBody").innerHTML = certs.map(cert => {
    let bgColor = "";
    let expiryDisplay = cert.expiry_date;

    if (cert.expiry_date) {
      const expiry = new Date(cert.expiry_date);
      const diffDays = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));

      if (!isNaN(diffDays)) {
        if (diffDays < 0) {
          bgColor = "background-color: #fff9c4;";
        } else if (diffDays <= 60) {
          bgColor = "background-color: #ffcdd2;";
        }
      }
    }

    return `<tr>
      <td contenteditable="false">${cert.name}</td>
      <td contenteditable="false">${cert.issue_date || ""}</td>
      <td contenteditable="false" style="${bgColor}">${expiryDisplay || ""}</td>
      <td class="actions no-print">
        <button class="edit" onclick="editCertificate(this, '${cert.id}')">โ๏ธ</button>
        <button class="delete" onclick="deleteCertificate('${cert.id}')">๐๏ธ</button>
      </td>
    </tr>`;
  }).join('');
}

    async function addCertificate() {
      const name = document.getElementById("cert-name").value.trim();
      const issue = document.getElementById("cert-issue").value;
      const expiry = document.getElementById("cert-expiry").value;
      if (!name || !issue || !expiry) {
        alert("ูุฑุฌู ููุก ุฌููุน ุงูุญููู");
        return;
      }

      const { error } = await supabase.from("certificates").insert({
        employee_id: employeeId,
        name,
        issue_date: issue,
        expiry_date: expiry
      });

      if (error) {
        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ: " + error.message);
      } else {
        document.getElementById("cert-name").value = "";
        document.getElementById("cert-issue").value = "";
        document.getElementById("cert-expiry").value = "";
        loadCertificates();
      }
    }

    async function deleteCertificate(id) {
      if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุดูุงุฏุฉุ")) return;
      await supabase.from("certificates").delete().eq("id", id);
      loadCertificates();
    }

    function calculateDuration(startDateStr, endDateStr) {
  const start = new Date(startDateStr);
  const end = new Date(endDateStr);
  if (isNaN(start) || isNaN(end)) return 0;

  const diffTime = end - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays > 0 ? diffDays : 0;
}

    async function editCertificate(button, id) {
      const row = button.closest("tr");
      const cells = row.querySelectorAll("td");
      const nameCell = cells[0];
      const issueCell = cells[1];
      const expiryCell = cells[2];

      if (button.textContent.includes("โ๏ธ")) {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = true;
        nameCell.focus();
        button.textContent = "๐พ";
        button.classList.remove("edit");
      } else {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = false;
        button.textContent = "โ๏ธ";
        button.classList.add("edit");

        const { error } = await supabase.from("certificates").update({
          name: nameCell.textContent.trim(),
          issue_date: issueCell.textContent.trim(),
          expiry_date: expiryCell.textContent.trim()
        }).eq("id", id);

        if (error) {
  alert("ูุดู ุงูุชุนุฏูู: " + error.message);
} else {
  loadCertificates();
}
      }
    }

    function smartDuration(joinDateStr, leaveDateStr, status) {
  const today = new Date();
  const join = joinDateStr ? new Date(joinDateStr) : null;
  const leave = leaveDateStr ? new Date(leaveDateStr) : null;

  if (status === "ููุชุญู" && join && (!leaveDateStr || !leave)) {
    return calculateDuration(join, today);
  }

  if (status === "ูุณุชุฑุงุญ" && leave && (!joinDateStr || !join)) {
    return calculateDuration(leave, today);
  }

  if (join && leave) {
    return calculateDuration(join, leave);
  }

  return 0;
}

    async function addServiceEntry() {
  const ship = document.getElementById("service-ship").value.trim();
  const status = document.getElementById("service-status").value.trim();
  const join_date = document.getElementById("service-join").value;
  const leave_date = document.getElementById("service-leave").value;
  const rank = document.getElementById("service-rank").value.trim();

  if (!ship || !status || !join_date || !leave_date || !rank) {
    alert("ูุฑุฌู ููุก ุฌููุน ุงูุญููู");
    return;
  }

  const duration = calculateDuration(join_date, leave_date);

  const { error } = await supabase.from("history").insert({
    employee_id: employeeId,
    ship,
    status,
    join_date,
    leave_date,
    duration,
    rank
  });

  if (error) {
    alert("ูุดู ูู ุฅุถุงูุฉ ุงูุฎุฏูุฉ: " + error.message);
  } else {
    // ููุฑูุบ ุงูุญููู ุจุนุฏ ุงูุฅุถุงูุฉ
    document.getElementById("service-ship").value = "";
    document.getElementById("service-status").value = "";
    document.getElementById("service-join").value = "";
    document.getElementById("service-leave").value = "";
    document.getElementById("service-rank").value = "";
    loadEmployeeProfile();
  }
}

async function uploadEmployeeImage() {
  const fileInput = document.getElementById("upload-image");
  const file = fileInput.files[0];

  if (!file) {
    alert("ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ");
    return;
  }

  // ๐ ุชุญูู ูู ุญุฌู ุงูุตูุฑุฉ (300KB = 300 * 1024 bytes)
  if (file.size > 300 * 1024) {
    alert("โ ุญุฌู ุงูุตูุฑุฉ ุฃูุจุฑ ูู 300KBุ ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃุตุบุฑ.");
    return;
  }

  const fileExt = file.name.split('.').pop();
  const fileName = `${employeeId}.${fileExt}`;
  const filePath = `employees/${fileName}`;

  const { error: uploadError } = await supabase.storage
    .from("employees")
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    alert("ูุดู ุฑูุน ุงูุตูุฑุฉ: " + uploadError.message);
    return;
  }

  const { data } = supabase.storage
    .from("employees")
    .getPublicUrl(filePath);

  const imageUrl = data.publicUrl;

  const { error: updateError } = await supabase
    .from("crew_list")
    .update({ image_url: imageUrl })
    .eq("id", employeeId);

  if (updateError) {
    alert("ูุดู ุญูุธ ุงูุฑุงุจุท: " + updateError.message);
  } else {
    document.getElementById("profile-image").src = imageUrl;
    alert("โ ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ");
  }
}

async function deleteEmployeeImage() {
  const fileExt = "jpg"; // ุฅุฐุง ุชุถูู ุงูุชุฏุงุฏ ูุนููู
  const filePath = `employees/${employeeId}.${fileExt}`;

  // ุญุฐู ูู Supabase Storage
  const { error: deleteError } = await supabase.storage
    .from("employees")
    .remove([filePath]);

  if (deleteError) {
    alert("ูุดู ุญุฐู ุงูุตูุฑุฉ: " + deleteError.message);
    return;
  }

  // ุญุฐู ุงูุฑุงุจุท ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  const { error: updateError } = await supabase
    .from("crew_list")
    .update({ image_url: null })
    .eq("id", employeeId);

  if (updateError) {
    alert("ูุดู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุธู: " + updateError.message);
    return;
  }

  document.getElementById("profile-image").src = "";
  alert("โ ุชู ุญุฐู ุงูุตูุฑุฉ ุจูุฌุงุญ");
}

document.addEventListener("DOMContentLoaded", () => {
  loadEmployeeProfile();
  loadServiceDropdowns();
});

async function loadServiceDropdowns() {
  const { data: crew } = await supabase.from("crew_list").select("ship, status, rank");
  if (!crew) return;

  const ships = [...new Set(crew.map(c => c.ship).filter(Boolean))];
  const statuses = [...new Set(crew.map(c => c.status).filter(Boolean))];
  const ranks = [...new Set(crew.map(c => c.rank).filter(Boolean))];

  const shipSelect = document.getElementById("service-ship");
  const statusSelect = document.getElementById("service-status");
  const rankSelect = document.getElementById("service-rank");

  ships.sort().forEach(ship => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = ship;
    shipSelect.appendChild(opt);
  });

  statuses.sort().forEach(status => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = status;
    statusSelect.appendChild(opt);
  });

  ranks.sort().forEach(rank => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = rank;
    rankSelect.appendChild(opt);
  });
}

function renderServiceTable(data) {
  let totalDays = 0;
  data.sort((a, b) => new Date(b.join_date) - new Date(a.join_date)); // ุชูุงุฒูู
  document.getElementById("seaTimeProfileBody").innerHTML = data.map(entry => {
    const dynamicDuration = smartDuration(entry.join_date, entry.leave_date, entry.status);
    if (entry.ship !== "ุงุณุชุฑุงุญุฉ") {
      totalDays += dynamicDuration;
    }
    return `<tr>
      <td>${entry.ship}</td>
      <td>${entry.status}</td>
      <td>${entry.join_date || ""}</td>
      <td>${entry.leave_date || ""}</td>
      <td>${dynamicDuration} ููู</td>
      <td>${entry.rank}</td>
      <td class="actions no-print">
        <button class="edit" onclick="editServiceEntry(this, '${entry.id}')">โ๏ธ</button>
        <button class="delete" onclick="deleteServiceEntry('${entry.id}')">๐๏ธ</button>
      </td>
    </tr>`;
  }).join('');
  document.getElementById("sea-total-days").textContent = totalDays;
  document.getElementById("sea-moves").textContent = data.length;
}

function filterServiceTable() {
  const type = document.getElementById("filterType").value;
  let filtered = [...fullHistory];

  if (type === "service") {
    filtered = fullHistory.filter(e => e.ship !== "ุงุณุชุฑุงุญุฉ");
  } else if (type === "rest") {
    filtered = fullHistory.filter(e => e.ship === "ุงุณุชุฑุงุญุฉ");
  }

  renderServiceTable(filtered);
}

function printSection(sectionId) {
  const section = document.getElementById(sectionId);
  const employeeName = document.getElementById("profile-name").textContent;
  const profileImage = document.getElementById("profile-image").src;
  const originalContent = document.body.innerHTML;

  const clonedSection = section.cloneNode(true);

  if (sectionId === 'service-section') {
    const seaSummary = document.querySelectorAll(".section")[2];
    const summaryClone = seaSummary.cloneNode(true);
    clonedSection.prepend(summaryClone);
  }

  const printableContent = `
    <div style="font-family: 'Cairo', sans-serif; direction: rtl; padding: 20px;">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        ${profileImage ? `<img src="${profileImage}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #aaa;">` : ''}
        <h2 style="margin: 0; color: #1a237e;">๐งพ ${employeeName}</h2>
      </div>
      <hr style="margin: 20px 0;">
      ${clonedSection.innerHTML}
    </div>
  `;

  document.body.innerHTML = printableContent;
  window.print();
  document.body.innerHTML = originalContent;
  location.reload();
}
  </script>
</body>
</html>