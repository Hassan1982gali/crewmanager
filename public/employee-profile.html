<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ø­Ø±ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      padding: 20px;
      background-color: #f0f4f8;
      direction: rtl;
    }
    h2 {
      text-align: center;
      color: #1a237e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      text-align: center;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #90caf9;
      color: #0d47a1;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-inline {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .form-inline input {
      padding: 5px;
      flex: 1;
    }
    .form-inline button {
      padding: 6px 20px;
      background-color: #1a237e;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    .actions button {
      margin: 2px;
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .actions .edit {
      background-color: #ffb300;
      color: white;
    }
    .actions .delete {
      background-color: #d32f2f;
      color: white;
    }
    @media print {
  .print-buttons {
    display: none;
  }
}
  </style>
</head>
<body>
  <h2>ğŸ“‹ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ø­Ø±ÙŠ</h2>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="export-certificates.html" target="_blank">
      <button style="padding: 10px 30px; background-color: #0d47a1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
        ğŸ“¥ ØªØµØ¯ÙŠØ± Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ù…
      </button>
    </a>
  </div>  

  <div class="print-buttons">
    <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„</button>
  </div>  

  <div class="section">
    <p><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> <span id="profile-name">---</span></p>
    <p><strong>ğŸ–ï¸ Ø§Ù„Ø±ØªØ¨Ø©:</strong> <span id="profile-rank">---</span></p>
    <p><strong>âš“ Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="profile-status">---</span></p>
    <p><strong>â›´ï¸ Ø§Ù„Ù†Ø§Ù‚Ù„Ø©:</strong> <span id="profile-ship">---</span></p>
  </div>

  <div class="section">
    <h3>ğŸ“ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h3>

    <div class="form-inline">
      <input type="text" id="cert-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
      <input type="date" id="cert-issue" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±">
      <input type="date" id="cert-expiry" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙØ§Ø°">
      <button onclick="addCertificate()">â• Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø§Ø¯Ø©</button>
    </div>

    <table>
      <thead>
        <tr><th>Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙØ§Ø°</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
      </thead>
      <tbody id="certificateTableBody"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>ğŸ§­ Ù…Ù„Ø®Øµ Sea Time</h3>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„Ø§Øª: <span id="sea-moves">0</span></p>
    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø±: <span id="sea-total-days">0</span> ÙŠÙˆÙ…</p>
  </div>

  <div class="section">
    <h3>ğŸ“…  Ø³Ø¬Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h3>
    <div class="form-inline">
      <input type="text" id="service-ship" placeholder="Ø§Ù„Ù†Ø§Ù‚Ù„Ø©">
      <input type="text" id="service-status" placeholder="Ø§Ù„Ø­Ø§Ù„Ø©">
      <input type="date" id="service-join" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
      <input type="date" id="service-leave" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
      <input type="text" id="service-rank" placeholder="Ø§Ù„Ø±ØªØ¨Ø©">
      <button onclick="addServiceEntry()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
    </div>    
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù†Ø§Ù‚Ù„Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù† ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="seaTimeProfileBody"></tbody>
    </table>
  </div>
  
  <script>
    const SUPABASE_URL = "https://hhglsrugbayccdboasaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZ2xzcnVnYmF5Y2NkYm9hc2FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NTEzMDIsImV4cCI6MjA1ODUyNzMwMn0._wHDCT00aa4IQYJNzpL4hjcz9BURslqJt9OUtfxjxlM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get("id");

    async function loadEmployeeProfile() {
    if (!employeeId) return;

    const { data: crew } = await supabase.from("crew_list").select("*").eq("id", employeeId).single();
    if (crew) {
      document.getElementById("profile-name").textContent = crew.name;
      document.getElementById("profile-rank").textContent = crew.rank;
      document.getElementById("profile-status").textContent = crew.status;
      document.getElementById("profile-ship").textContent = crew.ship;
    }

    const { data: history } = await supabase.from("history").select("*").eq("employee_id", employeeId);
    let totalDays = 0;
    document.getElementById("seaTimeProfileBody").innerHTML = history.map(entry => {
      totalDays += entry.duration;
      return `<tr>
        <td contenteditable="false">${entry.ship}</td>
        <td contenteditable="false">${entry.status}</td>
        <td contenteditable="false">${entry.join_date}</td>
        <td contenteditable="false">${entry.leave_date}</td>
        <td contenteditable="false">${entry.duration}</td>
        <td contenteditable="false">${entry.rank}</td>
        <td class="actions">
          <button class="edit" onclick="editServiceEntry(this, '${entry.id}')">âœï¸</button>
          <button class="delete" onclick="deleteServiceEntry('${entry.id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join('');

    document.getElementById("sea-moves").textContent = history.length;
    document.getElementById("sea-total-days").textContent = totalDays;

    loadCertificates();
  }

  async function deleteServiceEntry(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")) return;
    await supabase.from("history").delete().eq("id", id);
    loadEmployeeProfile();
  }

  async function editServiceEntry(button, id) {
    const row = button.closest("tr");
    const cells = row.querySelectorAll("td");
    const [shipCell, statusCell, joinCell, leaveCell, durationCell, rankCell] = cells;

    if (button.textContent.includes("âœï¸")) {
      shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = true;
      shipCell.focus();
      button.textContent = "ğŸ’¾";
      button.classList.remove("edit");
    } else {
      shipCell.contentEditable = statusCell.contentEditable = joinCell.contentEditable = leaveCell.contentEditable = durationCell.contentEditable = rankCell.contentEditable = false;
      button.textContent = "âœï¸";
      button.classList.add("edit");

      const { error } = await supabase.from("history").update({
        ship: shipCell.textContent.trim(),
        status: statusCell.textContent.trim(),
        join_date: joinCell.textContent.trim(),
        leave_date: leaveCell.textContent.trim(),
        duration: calculateDuration(joinCell.textContent.trim(), leaveCell.textContent.trim()),
        rank: rankCell.textContent.trim()
      }).eq("id", id);

      if (error) alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
      else loadEmployeeProfile();
    }
  }

    async function loadCertificates() {
  const { data: certs } = await supabase.from("certificates").select("*").eq("employee_id", employeeId);
  const today = new Date();

  document.getElementById("certificateTableBody").innerHTML = certs.map(cert => {
    let bgColor = "";
    let expiryDisplay = cert.expiry_date;

    if (cert.expiry_date) {
      const expiry = new Date(cert.expiry_date);
      const diffDays = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));

      if (!isNaN(diffDays)) {
        if (diffDays < 0) {
          bgColor = "background-color: #fff9c4;";
        } else if (diffDays <= 60) {
          bgColor = "background-color: #ffcdd2;";
        }
      }
    }

    return `<tr>
      <td contenteditable="false">${cert.name}</td>
      <td contenteditable="false">${cert.issue_date || ""}</td>
      <td contenteditable="false" style="${bgColor}">${expiryDisplay || ""}</td>
      <td class="actions">
        <button class="edit" onclick="editCertificate(this, '${cert.id}')">âœï¸</button>
        <button class="delete" onclick="deleteCertificate('${cert.id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }).join('');
}

    async function addCertificate() {
      const name = document.getElementById("cert-name").value.trim();
      const issue = document.getElementById("cert-issue").value;
      const expiry = document.getElementById("cert-expiry").value;
      if (!name || !issue || !expiry) {
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
      }

      const { error } = await supabase.from("certificates").insert({
        employee_id: employeeId,
        name,
        issue_date: issue,
        expiry_date: expiry
      });

      if (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + error.message);
      } else {
        document.getElementById("cert-name").value = "";
        document.getElementById("cert-issue").value = "";
        document.getElementById("cert-expiry").value = "";
        loadCertificates();
      }
    }

    async function deleteCertificate(id) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŸ")) return;
      await supabase.from("certificates").delete().eq("id", id);
      loadCertificates();
    }

    function calculateDuration(startDateStr, endDateStr) {
  const start = new Date(startDateStr);
  const end = new Date(endDateStr);
  if (isNaN(start) || isNaN(end)) return 0;

  const diffTime = end - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays > 0 ? diffDays : 0;
}

    async function editCertificate(button, id) {
      const row = button.closest("tr");
      const cells = row.querySelectorAll("td");
      const nameCell = cells[0];
      const issueCell = cells[1];
      const expiryCell = cells[2];

      if (button.textContent.includes("âœï¸")) {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = true;
        nameCell.focus();
        button.textContent = "ğŸ’¾";
        button.classList.remove("edit");
      } else {
        nameCell.contentEditable = issueCell.contentEditable = expiryCell.contentEditable = false;
        button.textContent = "âœï¸";
        button.classList.add("edit");

        const { error } = await supabase.from("certificates").update({
          name: nameCell.textContent.trim(),
          issue_date: issueCell.textContent.trim(),
          expiry_date: expiryCell.textContent.trim()
        }).eq("id", id);

        if (error) {
  alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
} else {
  loadCertificates();
}
      }
    }

    async function addServiceEntry() {
  const ship = document.getElementById("service-ship").value.trim();
  const status = document.getElementById("service-status").value.trim();
  const join_date = document.getElementById("service-join").value;
  const leave_date = document.getElementById("service-leave").value;
  const rank = document.getElementById("service-rank").value.trim();

  if (!ship || !status || !join_date || !leave_date || !rank) {
    alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  const duration = calculateDuration(join_date, leave_date);

  const { error } = await supabase.from("history").insert({
    employee_id: employeeId,
    ship,
    status,
    join_date,
    leave_date,
    duration,
    rank
  });

  if (error) {
    alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©: " + error.message);
  } else {
    // Ù†ÙØ±Ù‘Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById("service-ship").value = "";
    document.getElementById("service-status").value = "";
    document.getElementById("service-join").value = "";
    document.getElementById("service-leave").value = "";
    document.getElementById("service-rank").value = "";
    loadEmployeeProfile();
  }
}

    document.addEventListener("DOMContentLoaded", loadEmployeeProfile);
  </script>
</body>
</html>